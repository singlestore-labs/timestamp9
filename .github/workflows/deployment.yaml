name: CD

on:
  push:
    tags:
    - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install Rust (with Wasm targets)
      run: |
        set -e
        rustup update stable --no-self-update
        rustup default stable
        rustup target add wasm32-wasi
        rustup target add wasm32-unknown-unknown

    - name: Build Wasm
      run: cargo build --target wasm32-unknown-unknown

    - name: Build Extension
      run: |
        cp ./target/wasm32-wasi/release/ts9.wasm ./ts9.wasm
        tar cvf ts9.tar ts9.sql ts9.wasm ts9.wit 

    - name: Release
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
        title: ts9 ${ cargo metadtata | jq '.packages[] | select(.name=="ts9") .version' }
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        prerelease: false
        files: |
          ts9.tar
          ts9.sql
          ts9.wasm
          ts9.wit